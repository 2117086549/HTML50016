//global framerate for jquery animation
jQuery.fx.interval=20;if(typeof (window["collected"]&&window["used"])=="undefined")var collected=!1,used=!1;var room={settings:{inject:!1,grid_width:null,grid_height:null,tile_width:69.282,tile_height:40,drag_room:!1,room_glow:!1,player:!1,player_speed:null,player_position_x:null,player_position_y:null,collision_nodes:[],collected_items:collected,used_items:used,transparency_power:".7",volume:50,preload:[],execute:function(){}},generate:function(a){$("<div/>",{id:"white"}).appendTo("body").css({opacity:0}).animate({opacity:1},1e3,function(){$("body").css("background","#fff");room.settings.inject&&$("#the_game").empty();setTimeout(function(){$.extend(room.settings,a);$("#white").remove();room.inject()},500)})},inject:function(){if(room.settings.inject)$("#the_game").load(room.settings.inject+".html",function(){soundManager.stopAll();var a=window.room.settings.inject,b=function(){sound[a].play({volume:room.settings.volume,onfinish:function(){b(a)}})};b(a);$("body").css("background","#000");$("<div/>",{id:"white"}).appendTo("body").css({opacity:1}).animate({opacity:0},1e3,function(){$("body").find("#white").remove()});$.jStorage.set("is_in",room.settings.inject);room.draw_grid();room.place_player();room.set_collisions();room.set_collected_items();room.set_used_items();room.draggable();room.stroke();room.settings.execute();room.the_player.start();room.center();$(room.player_body()).sprite({no_of_frames:8}).spStop(!0)});else{room.draw_grid();room.draggable()}},player:function(){var a=$("#"+room.settings.player);return a},player_body:function(){var a=$("#sprite");return a},center:function(a,b){var c=$("#the_game").children("div").first(),d=$(window).width(),e=$(window).height(),f=$(room.player()).width(),g=$(room.player()).height(),h=$(room.player_body()).height(),i=$(room.player()).position(),j=$("body").find("#floor"),k=$(j).width(),l=$(j).height(),m=$(j).position();if(!a)$(c).css({left:d/2-f/2-i.left-m.left,top:e/2-g/2-i.top-m.top+h/3});else{if(!b)return!1;$("#tooltip").remove();$(c).stop(!0,!1).animate({left:d/2-f/2-i.left-m.left,top:e/2-g/2-i.top-m.top+h/3},b)}},draggable:function(){if(room.settings.drag_room)$("#the_game").children("div:first-child").draggable({start:function(){$("#the_game").children("div").stop()}});else return!1},stroke:function(){if(room.settings.room_glow)$("div.tile, div.active").hover(function(){$("#stroke").css({opacity:1})},function(){$("#stroke").css({opacity:.5})});else return!1},draw_grid:function(){var a=0,b=0;for(a=0;a<room.settings.grid_width;a++)for(b=0;b<room.settings.grid_height;b++)var c=$("<div/>",{id:a+"-"+b,css:{width:room.settings.tile_width,height:room.settings.tile_height,position:"absolute",left:a*room.settings.tile_width/2+(room.settings.grid_height*room.settings.tile_width/2-room.settings.tile_width/2)-room.settings.tile_width/2*b,top:b*room.settings.tile_height/2+a*room.settings.tile_height/2}}).appendTo("#floor").attr("class","tile").attr("data-x",a).attr("data-y",b).attr("data-z",b+(b+room.settings.grid_height*a))},place_player:function(){var a="#"+room.settings.player_position_x+"-"+room.settings.player_position_y,b=$(a).position();$(room.player()).css({top:b.top,left:b.left}).attr("data-x",room.settings.player_position_x).attr("data-y",room.settings.player_position_y)},set_collisions:function(){room.loop_and_add_class(room.settings.collision_nodes,"collision")},set_collected_items:function(){room.loop_and_remove(room.settings.collected_items)},set_used_items:function(){room.loop_and_remove(room.settings.used_items,!0)},loop_and_remove:function(a,b){var c=a.length;if(b){if(!(c>0))return!1;for(i=0;i<c;i++)$("#"+a[i]).remove()}else{if(!(c>0))return!1;for(i=0;i<c;i++)$("#the_game").find("#"+a[i]).remove()}},loop_and_add_class:function(a,b){var c=a.length;if(!(c>0))return!1;for(i=0;i<c;i++)$("#"+a[i]).addClass(b)},transparency:function(a,b){$(b).addClass("transparency");$(b).hover(function(){$(a).stop().css({opacity:room.settings.transparency_power})},function(){$(a).stop().css({opacity:1})})},pulse:function(a,b){function c(){setTimeout(function(){$(a).css({opacity:0});setTimeout(function(){$(a).css({opacity:1});c()},b*2)},b)}$(a).css({"-moz-transition":"opacity "+b/1e3+"s linear","-webkit-transition":"opacity "+b/1e3+"s linear","-o-transition":"opacity "+b/1e3+"s linear","-moz-transition":"opacity "+b/1e3+"s linear",transition:"opacity "+b/1e3+"s linear"});c()},the_player:{start:function(){$("div.tile").not(".collision").bind("click",function(){var a=$.jStorage.get("temp_path");a=[];$.jStorage.set("this_path",path);$(room.player_body()).spStart();$(room.player()).stop();room.the_player.go_to.start({target:!1,action:function(){!1}});room.the_player.footsteps();room.the_player.footsteps(12,4,!0);room.the_player.clear_path();room.the_player.find_path(this)})},go_to:{settings:{target:!1,action:function(){return!1}},start:function(a){$.extend(room.the_player.go_to.settings,a);if(room.the_player.go_to.settings.target){$(room.player_body()).spStart();$(room.player()).stop();room.the_player.footsteps();room.the_player.footsteps(12,4,!0);room.the_player.clear_path();room.the_player.find_path($("#"+room.the_player.go_to.settings.target))}}},footsteps:function(a,b,c){if(a&&b&&c)stop_steps=setInterval(function(){sound_footstep.play()},1e3/a*b);else{typeof window["stop_steps"]!="undefined"&&clearInterval(stop_steps);sound_footstep.play()}},clear_path:function(){$("div.tile").removeClass("marked")},adjacent:function(a,b,c,d){var e={up:{x:a,y:b-1,weight:function(){var a=0;$(e.up.select()).hasClass("collision")||$(e.up.select()).length==0?a=9999:$(e.up.select()).hasClass("marked")?a=100:a=Math.sqrt(Math.pow(c-e.up.x,2)+Math.pow(d-e.up.y,2));return a},select:function(){var a="#"+e.up.x+"-"+e.up.y;return a}},right:{x:a+1,y:b,weight:function(){var a=0;$(e.right.select()).hasClass("collision")||$(e.right.select()).length==0?a=9999:$(e.right.select()).hasClass("marked")?a=100:a=Math.sqrt(Math.pow(c-e.right.x,2)+Math.pow(d-e.right.y,2));return a},select:function(){var a="#"+e.right.x+"-"+e.right.y;return a}},down:{x:a,y:b+1,weight:function(){var a=0;$(e.down.select()).hasClass("collision")||$(e.down.select()).length==0?a=9999:$(e.down.select()).hasClass("marked")?a=100:a=Math.sqrt(Math.pow(c-e.down.x,2)+Math.pow(d-e.down.y,2));return a},select:function(){var a="#"+e.down.x+"-"+e.down.y;return a}},left:{x:a-1,y:b,weight:function(){var a=0;$(e.left.select()).hasClass("collision")||$(e.left.select()).length==0?a=9999:$(e.left.select()).hasClass("marked")?a=100:a=Math.sqrt(Math.pow(c-e.left.x,2)+Math.pow(d-e.left.y,2));return a},select:function(){var a="#"+e.left.x+"-"+e.left.y;return a}}},f=[];f.push([e.up.weight(),e.up.select(),e.up.x,e.up.y,"up"]);f.push([e.down.weight(),e.down.select(),e.down.x,e.down.y,"down"]);f.push([e.left.weight(),e.left.select(),e.left.x,e.left.y,"left"]);f.push([e.right.weight(),e.right.select(),e.right.x,e.right.y,"right"]);return f},find_path:function(a,b,c){if(!b&&!c)var b=parseInt($(room.player()).attr("data-x")),c=parseInt($(room.player()).attr("data-y"));var d=parseInt($(a).attr("data-x")),e=parseInt($(a).attr("data-y")),f=function(){function g(b,c){b.sort(function(a,b){return a[0]-b[0]});c.sort(function(a,b){return a[0]-b[0]});b[0][0]>c[0][0]?f=[a[1][1],a[1][4],a[1][2],a[1][3]]:f=[a[0][1],a[0][4],a[0][2],a[0][3]];return f}var a=room.the_player.adjacent(b,c,d,e),f=null;a.sort(function(a,b){return a[0]-b[0]});f=g(room.the_player.adjacent(a[0][2],a[0][3],d,e),room.the_player.adjacent(a[1][2],a[1][3],d,e));return f};go=function(a,b){var b=b?b:1;if(a.length>b){var c=$("#"+a[b][0]+"-"+a[b][1]).position(),d=$("#"+a[b][0]+"-"+a[b][1]).attr("data-z");a[b][3]==="up"?$(room.player_body()).spState(2):a[b][3]==="down"?$(room.player_body()).spState(3):a[b][3]==="right"?$(room.player_body()).spState(4):a[b][3]==="left"&&$(room.player_body()).spState(5);$(room.player()).attr("data-x",a[b][0]).attr("data-y",a[b][1]).css("z-index",d).animate({left:c.left,top:c.top},room.settings.player_speed,"linear",function(){b++;go(a,b)})}else{$(room.player_body()).spStop(!0);get_direction=$(room.player_body()).css("background-position"),direction=get_direction.substr(-6,4);room.center(!0,1e3);direction=="-310"?room.player_body().css("background-position","0 0"):direction=="-620"?room.player_body().css("background-position","-620px 0"):direction=="-930"?room.player_body().css("background-position","-930px 0"):direction=="1240"&&room.player_body().css("background-position","-310px 0");room.the_player.go_to.settings.action()&&room.the_player.go_to.settings.action();room.the_player.go_to.start({target:!1,action:function(){!1}});room.the_player.footsteps()}};var g=function(a){var b=[],c=function(a,b,c){var d=$("#"+b[a][0]+"-"+b[a][1]);if(b[a][0]===b[a-1][0]&&b[a][1]===b[a+1][1]){var e=$("#"+b[a+1][0]+"-"+b[a-1][1]),f=0;$("#"+b[a+1][0]+"-"+(b[a-1][1]+1)).hasClass("marked")&&f++;$("#"+(b[a+1][0]+1)+"-"+b[a-1][1]).hasClass("marked")&&f++;$("#"+b[a+1][0]+"-"+(b[a-1][1]-1)).hasClass("marked")&&f++;$("#"+(b[a+1][0]-1)+"-"+b[a-1][1]).hasClass("marked")&&f++;if($(e).hasClass("collision")||f<2)console.log("kolizja albo coś ;)");else{$(d).removeClass("marked");$(e).addClass("marked");c[b[a][2]]=[b[a+1][0],b[a-1][1],b[a][2],b[a+1][3]]}}else if(b[a][1]===b[a-1][1]&&b[a][0]===b[a+1][0]){var e=$("#"+b[a-1][0]+"-"+b[a+1][1]),f=0;$("#"+b[a-1][0]+"-"+(b[a+1][1]+1)).hasClass("marked")&&f++;$("#"+(b[a-1][0]+1)+"-"+b[a+1][1]).hasClass("marked")&&f++;$("#"+b[a-1][0]+"-"+(b[a+1][1]-1)).hasClass("marked")&&f++;$("#"+(b[a-1][0]-1)+"-"+b[a+1][1]).hasClass("marked")&&f++;if($(e).hasClass("collision")||f<2)console.log("kolizja albo coś ;)");else{$(d).removeClass("marked");$(e).addClass("marked");c[b[a][2]]=[b[a-1][0],b[a+1][1],b[a][2],b[a+1][3]]}}return c};if(a.length>=3){for(i=2;i<a.length;i++){var d=a[i][0],e=a[i][1],f=[];f.push([d-1,e-1]);f.push([d+1,e+1]);f.push([d-1,e+1]);f.push([d+1,e-1]);for(j=0;j<4;j++){var g=0;a[i-2][0]===f[j][0]&&a[i-2][1]==f[j][1]&&$("#"+a[i-1][0]+"-"+a[i-1][1]).length!==-1&&b.push(a[i])}}if(b.length>=2)for(i=1;i<b.length-1;i++)if(i%4===0||i===1)a=c(i,b,a)}return a},h=function(){var h=f()[2],i=f()[3],j=f()[1];if($(f()).length>0){var k=function(){var a=$.jStorage.get("temp_path");a.push([h,i,a.length,j]);$.jStorage.set("temp_path",a);var b=$.jStorage.get("temp_path"),c=g(b);$.jStorage.set("temp_path",[]);go(c)};if($.jStorage.get("temp_path").length===0){path=[];path.push([b,c]);$.jStorage.set("temp_path",path)}if(d===h&&e===i)k();else{$(f()[0]).addClass("marked");var l=$.jStorage.get("temp_path");l.push([h,i,l.length,j]);$.jStorage.set("temp_path",l);if(l.length>1)try{l[l.length-1][0]===l[l.length-3][0]&&l[l.length-1][1]===l[l.length-3][1]?k():room.the_player.find_path(a,h,i)}catch(m){room.the_player.find_path(a,h,i)}else room.the_player.find_path(a,h,i)}}};h()}}};