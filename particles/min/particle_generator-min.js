/*
 * Javascript/HTML5 Particle Generator v0.1
 * http://scurker.com/projects/particles
 * 
 * Copyright (c) 2010 Jason Wilson, http://scurker.com
 * 
 * Licensed under the MIT license: http://www.opensource.org/licenses/mit-license.php
 *//**
 * Extend an object and its properties
 * Idea mainly from jQuery's extend method
 */function extend(){var a=arguments[0],b=arguments.length,c=1,d;typeof a!="object"&&toString.call(a)=="[object Function]"&&(a={});for(;c<b;c++)if((d=arguments[c])!=null)for(var e in d){var f=a[e],g=d[e];g!==undefined&&(a[e]=g)}return a}function ParticleCanvas(a,b){if(!a)return;this.ctx=a.getContext("2d");this.height=a.height;this.width=a.width;b=extend({x:this.width/2,y:this.height/2},b);this.particleGenerator=new ParticleGenerator({position:new Vector(b)});return this}var Vector=function(a){a=extend({x:0,y:0},a);this.x=a.x;this.y=a.y;return this};Vector.prototype={add:function(a){this.x+=a.x;this.y+=a.y;return this},clone:function(){return new Vector({x:this.x,y:this.y})},distance:function(a){var b=this.x-a.x,c=this.y-a.y;return Math.sqrt(b*b+c*c)},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},points:function(a){if(a===undefined)return{x:this.x,y:this.y};a=extend(this.p,a);this.x=a.x;this.y=a.y;return this},rotate:function(a){var b=Math.cos(a),c=Math.sin(a),d=this.x,e=this.y;this.x=d*b-e*c;this.y=d*c+e*b;return this},subtract:function(a){this.x-=a.x;this.y-=a.y;return this}};var ParticleGenerator=function(a){var a=extend({shape:"circle",velocity:new Vector({y:-3}),xVariance:20,yVariance:5,spawnSpeed:25,generations:1e5,maxParticles:500,size:20,sizeVariance:5,life:30,lifeVariance:10,direction:0,directionVariance:15,color:"#cef",opacity:1,onDraw:function(a){var b=-this.age*3;a.size*=.98;a.color="rgb(255, "+(b+255)+", 68)";a.opacity=.5-a.age/a.life*.4}},a);this.p=a.position;this.v=a.velocity;this.options=a;this.active=!0;this.age=0;return this};ParticleGenerator.prototype={particles:[],update:function(){if(this.options.generations!=-1&&this.age<=this.options.generations){this.particles.length==0&&this.options.generations<=this.age&&(this.active=!1);this.age++}for(var a in this.particles){var b=this.particles[a];b.active===!1?this.particles.splice(a,1):b.update()}for(var c=0;c<this.options.spawnSpeed;c++){if(this.particles.length>=this.options.maxParticles||this.options.generations<=this.age)return;this.particles.push(new Particle(this.options))}},draw:function(a){for(var b in this.particles)this.particles[b].draw(a)}};var Particle=function(a){var b=function(a){return(Math.random()*a<<1)-a},c=new Vector({x:b(a.xVariance),y:b(a.yVariance)}),d=a.direction+b(a.directionVariance);extend(this,a,{p:a.position.clone().add(c),v:a.velocity.clone().rotate(d*Math.PI/180),age:0,life:a.life+b(a.lifeVariance),size:a.size+b(a.sizeVariance),active:!0});return this};Particle.prototype={update:function(){this.age>=this.life&&(this.active=!1);this.p.add(this.v);this.age++},draw:function(a){typeof this.onDraw=="function"&&this.onDraw(this);a.save();a.fillStyle=this.color;try{a.globalAlpha=this.opacity}catch(b){console.debug(b)}a.translate(this.p.x,this.p.y);switch(this.shape){case"square":a.fillRect(-this.size/2,-this.size/2,this.size,this.size);break;case"circle":a.beginPath();a.arc(0,0,this.size/2,0,Math.PI/180,!0);a.closePath();a.fill()}a.restore()}};ParticleCanvas.prototype={start:function(){var a=this;return setInterval(function(){a.tick()},1e3/60)},init:function(){var a=this.ctx;a.clearRect(0,0,this.width,this.height);a.fillStyle="#000";a.beginPath();a.fillRect(0,0,this.width,this.height);a.stroke();a.save()},update:function(a){for(var b in a)a[b]=isNaN(parseFloat(a[b]))?a[b]:parseFloat(a[b]);a.velocity instanceof Vector||(a.velocity=new Vector({y:-a.velocity}));a.directionVariance=parseInt(a.directionVariance);extend(this.particleGenerator.options,a)},tick:function(){this.init();this.particleGenerator.update(this.ctx);this.particleGenerator.draw(this.ctx)}};